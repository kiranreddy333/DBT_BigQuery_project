{{ config(
    materialized='table',
    schema='google_analytics_sample'
)}}

-- Unnest the `hits` column to access its nested fields
WITH unnested_data AS (
    SELECT
        *,
        hs.*  
    FROM
        {{ ref('main_data') }},
        UNNEST(hits) AS hs
)

SELECT
    visitId,
    hits.hitNumber,
    hits.time,
    hits.hour,
    hits.minute,
    hits.isSecure,
    hits.isInteraction,
    hits.isEntrance,
    hits.isExit,
    hits.referer,
    hits.page.pagePath,
    hits.page.hostname,
    hits.page.pageTitle,
    hits.page.searchkeyword,
    hits.page.searchCategory,
    hits.page.pagePathLevel1,
    hits.page.pagePathLevel2,
    hits.page.pagePathLevel3,
    hits.page.pagePathLevel4,
    hits.transaction.transactionId as transactionId1,
    hits.transaction.transactionRevenue,
    hits.transaction.transactionTax,
    hits.transaction.transactionShipping,
    hits.transaction.affiliation,
    hits.transaction.currencyCode as currencyCode1,
    hits.transaction.localTransactionRevenue,
    hits.transaction.localTransactionTax,
    hits.transaction.localTransactionShipping,
    hits.transaction.transactionCoupon,
    hits.item.transactionId as transactionId2,
    hits.item.productName,
    hits.item.productCategory,
    hits.item.productSku,
    hits.item.itemQuantity,
    hits.item.itemRevenue,
    hits.item.currencyCode as currencyCode2,
    hits.item.localItemRevenue,
    hits.contentInfo.contentDescription,
    hits.appInfo.name,
    hits.appInfo.version,
    hits.appInfo.id,
    hits.appInfo.installerId,
    hits.appInfo.appInstallerId,
    hits.appInfo.appName,
    hits.appInfo.appVersion,
    hits.appInfo.appId,
    hits.appInfo.screenName,
    hits.appInfo.landingScreenName,
    hits.appInfo.exitScreenName,
    hits.appInfo.screenDepth,
    hits.exceptionInfo.description,
    hits.exceptionInfo.isFatal,
    hits.exceptionInfo.exceptions,
    hits.exceptionInfo.fatalExceptions,
    hits.eventInfo.eventCategory,
    hits.eventInfo.eventAction,
    hits.eventInfo.eventLabel,
    hits.eventInfo.eventValue,
    
    hits.promotionActionInfo.promoIsView,
    hits.promotionActionInfo.promoIsClick,
    hits.refund.refundAmount,
    hits.refund.localRefundAmount,
    hits.eCommerceAction.action_type,
    hits.eCommerceAction.step,
    hits.eCommerceAction.option,
    hits.publisher.dfpClicks,
    hits.publisher.dfpImpressions,
    hits.publisher.dfpMatchedQueries,
    hits.publisher.dfpMeasurableImpressions,
    hits.publisher.dfpQueries,
    hits.publisher.dfpRevenueCpm,
    hits.publisher.dfpRevenueCpc,
    hits.publisher.dfpViewableImpressions,
    hits.publisher.dfpPagesViewed,
    hits.publisher.adsenseBackfillDfpClicks,
    hits.publisher.adsenseBackfillDfpImpressions,
    hits.publisher.adsenseBackfillDfpMatchedQueries,
    hits.publisher.adsenseBackfillDfpMeasurableImpressions,
    hits.publisher.adsenseBackfillDfpPagesViewed,
    hits.publisher.adxBackfillDfpClicks,
    hits.publisher.adxBackfillDfpImpressions,
    hits.publisher.adxBackfillDfpMeasurableImpressions,
    hits.publisher.adxBackfillDfpPagesViewed,
    hits.publisher.adxClicks,
    hits.publisher.adxImpressions,
    hits.publisher.adxMatchedQueries,
    hits.publisher.adxMeasurableImpressions,
    hits.publisher.adxQueries,
    hits.publisher.adxRevenue,
    hits.publisher.adxViewableImpressions,
    hits.publisher.adxPagesViewed,
    hits.publisher.adsViewed,
    hits.publisher.adsUnitsViewed,
    hits.publisher.adsUnitsMatched,
    hits.publisher.viewableAdsViewed,
    hits.publisher.measurableAdsViewed,
    hits.publisher.adsPagesViewed,
    hits.publisher.adsClicked,
    hits.publisher.adsRevenue,
    hits.publisher.dfpAdgroup,
    hits.publisher.dfpAdUnits,
    hits.publisher.dfpNetWorkId,
    hits.type,
    hits.social.socialInteractionNetwork,
    hits.social.socialInteractionAction,
    hits.social.socialInteractions,
    hits.social.socialInteractionTarget,
    hits.social.socialNetwork,
    hits.social.uniqueSocialInteractions,
    hits.social.hasSocialSourceReferral,
    hits.social.socialInteractionNetworkAction,
    hits.latencyTracking.pageLoadSample,
    hits.latencyTracking.pageLoadTime,
    hits.latencyTracking.pageDownloadTime,
    hits.latencyTracking.redirectionTime,
    hits.latencyTracking.speedMetricsSample,
    hits.latencyTracking.domainLookupTime,
    hits.latencyTracking.serverConnectionTime,
    hits.latencyTracking.serverResponseTime,
    hits.latencyTracking.domLatencyMetricsSample,
    hits.latencyTracking.domInteractiveTime,
    hits.latencyTracking.domContentLoadedTime,
    hits.latencyTracking.userTimingValue,
    hits.latencyTracking.userTimingSample,
    hits.latencyTracking.userTimingVariable,
    hits.latencyTracking.userTimingCategory,
    hits.latencyTracking.userTimingLabel,
    hits.sourcePropertyInfo.sourcePropertyDisplayName,
    hits.sourcePropertyInfo.sourcePropertyTrackingId,
    hits.contentGroup.contentGroup1,
    hits.contentGroup.contentGroup2,
    hits.contentGroup.contentGroup3,
    hits.contentGroup.contentGroup4,
    hits.contentGroup.contentGroup5,
    hits.contentGroup.previouscontentGroup1,
    hits.contentGroup.previouscontentGroup2,
    hits.contentGroup.previouscontentGroup3,
    hits.contentGroup.previouscontentGroup4,
    hits.contentGroup.previouscontentGroup5,
    hits.contentGroup.contentGroupUniqueViews1,
    hits.contentGroup.contentGroupUniqueViews2,
    hits.contentGroup.contentGroupUniqueViews3,
    hits.contentGroup.contentGroupUniqueViews4,
    hits.contentGroup.contentGroupUniqueViews5,
    hits.dataSource
    
FROM
    unnested_data,
    UNNEST(hits) AS hits
